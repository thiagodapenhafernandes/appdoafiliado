<% can_edit_ad_spend = current_user.can_access_advanced_analytics? %>

<% unless can_edit_ad_spend %>
  <div class="mb-6">
    <%= render 'shared/plan_gate',
        title: 'Edite gasto em ads e ROI no Plano Completo',
        message: 'Informe o investimento por subID para calcular ROI e CPA automaticamente. Faça upgrade para registrar seus gastos diretamente na tabela.',
        cta_label: 'Ver Plano Completo' %>
  </div>
<% end %>

<!-- Resumo de SubIDs -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
  <div class="bg-white shadow rounded-lg p-6 border-l-4 border-cyan-500">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">SubIDs Ativos</p>
        <p class="text-2xl font-bold text-cyan-600"><%= @performance_by_subid.count %></p>
      </div>
      <div class="w-12 h-12 bg-cyan-100 rounded-lg flex items-center justify-center">
        <svg class="w-6 h-6 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
      </div>
    </div>
  </div>

  <div class="bg-white shadow rounded-lg p-6 border-l-4 border-emerald-500">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">Melhor SubID</p>
        <p class="text-lg font-bold text-emerald-600"><%= @performance_by_subid.first[0] rescue 'N/A' %></p>
        <p class="text-sm text-gray-500">R$ <%= number_with_precision(@performance_by_subid.first[1][:commission], precision: 2, delimiter: '.', separator: ',') rescue '0,00' %></p>
      </div>
      <div class="w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center">
        <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
        </svg>
      </div>
    </div>
  </div>

  <div class="bg-white shadow rounded-lg p-6 border-l-4 border-orange-500">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">ROI Médio</p>
        <% avg_roi = @performance_by_subid.values.sum { |v| v[:roi] || 0 } / [@performance_by_subid.count, 1].max %>
        <p class="text-2xl font-bold text-orange-600"><%= number_with_precision(avg_roi, precision: 1) %>%</p>
      </div>
      <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
        </svg>
      </div>
    </div>
  </div>

  <div class="bg-white shadow rounded-lg p-6 border-l-4 border-rose-500">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">CPA Médio</p>
        <% avg_cpa = @performance_by_subid.values.sum { |v| v[:cpa] || 0 } / [@performance_by_subid.count, 1].max %>
        <p class="text-2xl font-bold text-rose-600">R$ <%= number_with_precision(avg_cpa, precision: 2, delimiter: '.', separator: ',') %></p>
      </div>
      <div class="w-12 h-12 bg-rose-100 rounded-lg flex items-center justify-center">
        <svg class="w-6 h-6 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
      </div>
    </div>
  </div>
</div>

<!-- Análise de Pedidos Diretos vs Indiretos -->
<div class="bg-white shadow rounded-lg p-6 mb-8">
  <div class="flex items-center justify-between mb-6">
    <h3 class="text-lg font-semibold text-gray-900">Pedidos Diretos & Indiretos</h3>
    <div class="text-sm text-gray-500">Análise de origem dos pedidos</div>
  </div>
  
  <!-- Texto Informativo -->
  <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
    <div class="flex">
      <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
        </svg>
      </div>
      <div class="ml-3">
        <p class="text-sm text-blue-700">
          <strong>Pedidos Diretos:</strong> Compras realizadas na mesma loja que você promoveu. 
          <strong>Pedidos Indiretos:</strong> Compras em lojas diferentes da que você promoveu, mas que geraram comissão por conta do seu link.
        </p>
      </div>
    </div>
  </div>
  
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Métricas -->
    <div class="space-y-4">
      <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-blue-800">Pedidos Diretos</p>
            <p class="text-2xl font-bold text-blue-900"><%= @direct_indirect_analysis[:direct][:orders] %></p>
          </div>
          <div class="text-blue-600">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
            </svg>
          </div>
        </div>
        <p class="text-sm text-blue-700 mt-2">R$ <%= number_with_precision(@direct_indirect_analysis[:direct][:commission], precision: 2, delimiter: '.', separator: ',') %> em comissões</p>
      </div>
      
      <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-green-800">Comissões Diretas</p>
            <p class="text-2xl font-bold text-green-900">R$ <%= number_with_precision(@direct_indirect_analysis[:direct][:commission], precision: 2, delimiter: '.', separator: ',') %></p>
          </div>
          <div class="text-green-600">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
            </svg>
          </div>
        </div>
        <p class="text-sm text-green-700 mt-2"><%= number_with_precision(@direct_indirect_analysis[:direct][:percentage], precision: 1) %>% do total</p>
      </div>

      <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-purple-800">Pedidos Indiretos</p>
            <p class="text-2xl font-bold text-purple-900"><%= @direct_indirect_analysis[:indirect][:orders] %></p>
          </div>
          <div class="text-purple-600">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
          </div>
        </div>
        <p class="text-sm text-purple-700 mt-2">R$ <%= number_with_precision(@direct_indirect_analysis[:indirect][:commission], precision: 2, delimiter: '.', separator: ',') %> em comissões</p>
      </div>

      <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-lg">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-orange-800">Comissões Indiretas</p>
            <p class="text-2xl font-bold text-orange-900">R$ <%= number_with_precision(@direct_indirect_analysis[:indirect][:commission], precision: 2, delimiter: '.', separator: ',') %></p>
          </div>
          <div class="text-orange-600">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
            </svg>
          </div>
        </div>
        <p class="text-sm text-orange-700 mt-2"><%= number_with_precision(@direct_indirect_analysis[:indirect][:percentage], precision: 1) %>% do total</p>
      </div>
    </div>
    
    <!-- Gráfico de Diretos vs Indiretos -->
    <div class="lg:col-span-2">
      <canvas id="directIndirectChart" class="h-64"></canvas>
    </div>
  </div>
</div>

<!-- Tabela Detalhada de SubIDs -->
<div class="bg-white shadow rounded-lg p-6">
  <div class="flex items-center justify-between mb-6">
    <h3 class="text-lg font-semibold text-gray-900">Análise por SubID</h3>
    <div class="flex items-center space-x-4">
      <div class="text-sm text-gray-500">Filtrar por:</div>
      <select id="subidFilter" class="border border-gray-300 rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <option value="all">Todos os SubIDs</option>
        <option value="profitable">Apenas Lucrativos</option>
        <option value="non_profitable">Não Lucrativos</option>
      </select>
    </div>
  </div>
  
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200" id="subidTable">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SubID</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comissões</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendas</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pedidos</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gasto em Ads</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ROI</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @performance_by_subid.each_with_index do |(subid, data), index| %>
          <% roi = data[:roi] || 0 %>
          <% is_profitable = roi > 0 %>
          <tr class="hover:bg-gray-50 subid-row" 
              data-profitable="<%= is_profitable %>"
              data-roi="<%= roi %>">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10">
                  <div class="h-10 w-10 rounded-lg bg-gradient-to-br from-cyan-400 to-cyan-600 flex items-center justify-center">
                    <span class="text-white font-medium text-sm"><%= index + 1 %></span>
                  </div>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">
                    <%= subid.present? ? subid : 'Não informado' %>
                  </div>
                  <div class="text-sm text-gray-500">
                    <%= number_with_precision(data[:percentage] || 0, precision: 1) %>% do total
                  </div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-green-600">R$ <%= number_with_precision(data[:commission], precision: 2, delimiter: '.', separator: ',') %></div>
              <% avg_commission = data[:orders] > 0 ? data[:commission] / data[:orders] : 0 %>
              <div class="text-sm text-gray-500">R$ <%= number_with_precision(avg_commission, precision: 2, delimiter: '.', separator: ',') %>/pedido</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">R$ <%= number_with_precision(data[:sales], precision: 2, delimiter: '.', separator: ',') %></div>
              <% avg_sale = data[:orders] > 0 ? data[:sales] / data[:orders] : 0 %>
              <div class="text-sm text-gray-500">R$ <%= number_with_precision(avg_sale, precision: 2, delimiter: '.', separator: ',') %>/pedido</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900"><%= data[:orders] %></div>
              <div class="text-sm text-gray-500">pedidos</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% ad_spend_value = data[:ad_spend] || 0 %>
              <div class="editable-ad-spend" 
                   data-subid="<%= subid.present? ? subid : 'Não informado' %>" 
                   data-value="<%= ad_spend_value %>"
                   data-editable="<%= can_edit_ad_spend %>">
                <div class="ad-spend-display text-sm text-gray-900 <%= can_edit_ad_spend ? 'cursor-pointer hover:bg-gray-100' : '' %> p-1 rounded">
                  R$ <span class="ad-spend-value"><%= number_with_precision(ad_spend_value, precision: 2, delimiter: '.', separator: ',') %></span>
                </div>
                <% if can_edit_ad_spend %>
                  <input type="number" class="ad-spend-input hidden w-full text-sm border-gray-300 rounded px-2 py-1" step="0.01" min="0">
                <% end %>
              </div>
              <% cpa = data[:orders] > 0 && ad_spend_value ? ad_spend_value / data[:orders] : 0 %>
              <div class="text-sm text-gray-500">CPA: R$ <span class="cpa-value"><%= number_with_precision(cpa, precision: 2, delimiter: '.', separator: ',') %></span></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium <%= roi > 0 ? 'text-green-600' : roi < 0 ? 'text-red-600' : 'text-gray-600' %>">
                <%= number_with_precision(roi, precision: 1) %>%
              </div>
              <div class="text-sm text-gray-500">
                <%= roi > 0 ? 'Lucrativo' : roi < 0 ? 'Prejuízo' : 'Neutro' %>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% if is_profitable %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                  </svg>
                  Lucrativo
                </span>
              <% else %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                  <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                  </svg>
                  Prejuízo
                </span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Funcionalidade de edição inline para Gasto em Ads
  const editableAdSpends = document.querySelectorAll('.editable-ad-spend');
  
  editableAdSpends.forEach(function(editable) {
    if (editable.dataset.editable !== 'true') { return; }
    const display = editable.querySelector('.ad-spend-display');
    const input = editable.querySelector('.ad-spend-input');
    const valueSpan = editable.querySelector('.ad-spend-value');
    const cpaSpan = editable.closest('td').querySelector('.cpa-value');
    const subid = editable.dataset.subid;
    
    // Double-click para editar
    display.addEventListener('dblclick', function() {
      const currentValue = parseFloat(editable.dataset.value) || 0;
      input.value = currentValue.toFixed(2);
      display.classList.add('hidden');
      input.classList.remove('hidden');
      input.focus();
      input.select();
    });
    
    // Salvar ao pressionar Enter
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        saveAdSpend();
      } else if (e.key === 'Escape') {
        cancelEdit();
      }
    });
    
    // Salvar ao perder o foco
    input.addEventListener('blur', function() {
      saveAdSpend();
    });
    
    function saveAdSpend() {
      const newValue = parseFloat(input.value) || 0;
      
      if (newValue === parseFloat(editable.dataset.value)) {
        cancelEdit();
        return;
      }
      
      // Mostrar loading
      display.innerHTML = '<div class="text-gray-500">Salvando...</div>';
      display.classList.remove('hidden');
      input.classList.add('hidden');
      
      // Fazer requisição AJAX
      fetch('/analytics/update_ad_spend', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify({
          subid: subid,
          ad_spend: newValue
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Atualizar valores
          editable.dataset.value = data.ad_spend;
          valueSpan.textContent = data.formatted_ad_spend;
          cpaSpan.textContent = data.formatted_cpa;
          
          // Encontrar e atualizar ROI na mesma linha
          const roiCell = editable.closest('tr').querySelector('td:nth-child(6)');
          if (roiCell) {
            const roiValue = roiCell.querySelector('.text-sm.font-medium');
            const roiStatus = roiCell.querySelector('.text-sm.text-gray-500');
            
            if (roiValue) {
              roiValue.textContent = data.formatted_roi + '%';
              // Atualizar cor baseada no ROI
              roiValue.className = 'text-sm font-medium ' + (data.roi > 0 ? 'text-green-600' : data.roi < 0 ? 'text-red-600' : 'text-gray-600');
            }
            
            if (roiStatus) {
              roiStatus.textContent = data.roi > 0 ? 'Lucrativo' : data.roi < 0 ? 'Prejuízo' : 'Neutro';
            }
          }
          
          // Restaurar display normal
          display.innerHTML = '<div class="ad-spend-display text-sm text-gray-900 cursor-pointer hover:bg-gray-100 p-1 rounded">R$ <span class="ad-spend-value">' + data.formatted_ad_spend + '</span></div>';
        } else {
          alert('Erro ao salvar: ' + (data.errors ? data.errors.join(', ') : 'Erro desconhecido'));
          cancelEdit();
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar o valor');
        cancelEdit();
      });
    }
    
    function cancelEdit() {
      display.classList.remove('hidden');
      input.classList.add('hidden');
    }
  });

  // Gráfico de Diretos vs Indiretos
  const directIndirectCtx = document.getElementById('directIndirectChart').getContext('2d');
  
  new Chart(directIndirectCtx, {
    type: 'pie',
    data: {
      labels: ['Comissões Diretas', 'Comissões Indiretas'],
      datasets: [{
        data: [<%= @direct_indirect_analysis[:direct][:commission] %>, <%= @direct_indirect_analysis[:indirect][:commission] %>],
        backgroundColor: ['#3B82F6', '#10B981'],
        borderWidth: 2,
        borderColor: '#ffffff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            usePointStyle: true
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed;
              const total = <%= @direct_indirect_analysis[:total][:commission] %>;
              const percentage = ((value / total) * 100).toFixed(1);
              return label + ': R$ ' + value.toFixed(2).replace('.', ',') + ' (' + percentage + '%)';
            }
          }
        }
      }
    }
  });

  // Filtro da tabela de SubIDs
  const subidFilter = document.getElementById('subidFilter');
  const tableRows = document.querySelectorAll('.subid-row');
  
  subidFilter.addEventListener('change', function() {
    const filterValue = this.value;
    
    tableRows.forEach(row => {
      const isProfitable = row.dataset.profitable === 'true';
      const roi = parseFloat(row.dataset.roi);
      
      let shouldShow = true;
      
      switch(filterValue) {
        case 'profitable':
          shouldShow = isProfitable;
          break;
        case 'non_profitable':
          shouldShow = !isProfitable;
          break;
        case 'all':
        default:
          shouldShow = true;
          break;
      }
      
      row.style.display = shouldShow ? '' : 'none';
    });
  });
});
</script>
