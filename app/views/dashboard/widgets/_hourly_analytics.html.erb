<%= plan_access_overlay('pro') do %>
  <div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg leading-6 font-medium text-gray-900">üìä An√°lises de Hor√°rio</h3>
        <div class="flex items-center space-x-2">
          <span class="text-sm text-gray-500">Cliques √∫nicos</span>
          <button class="text-gray-400 hover:text-gray-600">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Layout melhorado dos dados hor√°rios -->
      <div class="space-y-4">
        <% 
          # Obter dados reais de cliques por hora do banco de dados
          # Se n√£o houver dados reais, usar dados simulados baseados em padr√µes t√≠picos
          if current_user.website_clicks.any?
            # Dados reais do banco
            hourly_data = current_user.website_clicks
              .where(click_time: 30.days.ago..Time.current)
              .group("EXTRACT(HOUR FROM click_time)")
              .count
            total_real_clicks = hourly_data.values.sum
            using_real_data = true
          else
            # Dados simulados mais real√≠sticos se n√£o houver dados reais
            hourly_data = {}
            total_real_clicks = 0
            using_real_data = false
          end
          
          # Primeiro, vamos calcular todos os dados hor√°rios (reais ou simulados)
          complete_hourly_data = {}
          (0..23).each do |hour|
            if using_real_data
              # Usar dados reais se dispon√≠veis
              complete_hourly_data[hour] = hourly_data[hour.to_f] || hourly_data[hour.to_s] || 0
            else
              # Simular dados baseado em padr√µes t√≠picos
              complete_hourly_data[hour] = case hour
              when 0..5   then [0, 1, 2].sample  # Madrugada - muito baixa
              when 6..8   then [1, 2, 3].sample  # Manh√£ cedo - baixa
              when 9..11  then [3, 4, 5, 6].sample  # Manh√£ - m√©dia
              when 12..14 then [5, 6, 7, 8, 9].sample  # Almo√ßo/tarde - alta
              when 15..17 then [7, 8, 9, 10].sample  # Tarde - pico
              when 18..20 then [4, 5, 6, 7, 8].sample  # In√≠cio noite - m√©dia-alta
              when 21..23 then [2, 3, 4, 5].sample  # Noite - baixa
              end
            end
          end
          
          # Agora calcular os per√≠odos baseado nos dados completos
          periods = [
            { 
              name: "Madrugada", 
              hours: "00h-05h", 
              color: "bg-blue-500", 
              range: (0..5),
              clicks: (0..5).sum { |hour| complete_hourly_data[hour] || 0 }
            },
            { 
              name: "Manh√£", 
              hours: "06h-11h", 
              color: "bg-green-500", 
              range: (6..11),
              clicks: (6..11).sum { |hour| complete_hourly_data[hour] || 0 }
            },
            { 
              name: "Tarde", 
              hours: "12h-17h", 
              color: "bg-orange-500", 
              range: (12..17),
              clicks: (12..17).sum { |hour| complete_hourly_data[hour] || 0 }
            },
            { 
              name: "Noite", 
              hours: "18h-23h", 
              color: "bg-purple-500", 
              range: (18..23),
              clicks: (18..23).sum { |hour| complete_hourly_data[hour] || 0 }
            }
          ]
          
          # Recalcular total para dados simulados
          total_displayed_clicks = complete_hourly_data.values.sum
        %>
        
        <!-- Per√≠odos do dia -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
          <% periods.each do |period| %>
            <div class="text-center p-3 rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
              <div class="<%= period[:color] %> w-full h-3 rounded-full mb-2 opacity-80"></div>
              <div class="text-sm font-medium text-gray-900"><%= period[:name] %></div>
              <div class="text-xs text-gray-500"><%= period[:hours] %></div>
              <div class="text-lg font-bold text-gray-800 mt-1"><%= period[:clicks] %></div>
              <div class="text-xs text-gray-400">cliques</div>
            </div>
          <% end %>
        </div>

        <!-- Gr√°fico de Barras por Hora -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-sm font-medium text-gray-700 mb-3">Distribui√ß√£o por Hora</h4>
          <div id="hourlyBarChartWrapper">
            <canvas id="hourlyBarChart" height="120"></canvas>
          </div>
          <div class="mt-3 text-center">
            <p class="text-xs text-gray-500">
              <%= using_real_data ? "üìä Dados reais dos √∫ltimos 30 dias (#{total_displayed_clicks} cliques)" : "üìã Dados simulados - conecte suas an√°lises para ver dados reais (#{total_displayed_clicks} cliques de exemplo)" %>
            </p>
          </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
          // Suporte a Turbo/Hotwire e destrui√ß√£o correta do gr√°fico
          function renderHourlyBarChart() {
            // Remove canvas antigo se existir
            var wrapper = document.getElementById('hourlyBarChartWrapper');
            if (!wrapper) return;
            var oldCanvas = document.getElementById('hourlyBarChart');
            if (oldCanvas) {
              if (window.hourlyBarChartInstance) {
                window.hourlyBarChartInstance.destroy();
                window.hourlyBarChartInstance = null;
              }
              wrapper.removeChild(oldCanvas);
            }
            // Cria novo canvas
            var canvas = document.createElement('canvas');
            canvas.id = 'hourlyBarChart';
            canvas.height = 120;
            wrapper.appendChild(canvas);
            var ctx = canvas.getContext('2d');
            var hourlyData = <%= raw((0..23).map { |h| complete_hourly_data[h] || 0 }.to_json) %>;
            var labels = <%= raw((0..23).map { |h| sprintf("%02d:00", h) }.to_json) %>;
            window.hourlyBarChartInstance = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Cliques por Hora',
                  data: hourlyData,
                  backgroundColor: 'rgba(54, 162, 235, 0.7)',
                  borderColor: 'rgba(54, 162, 235, 1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                  }
                }
              }
            });
          }
          document.addEventListener('turbo:load', renderHourlyBarChart);
          document.addEventListener('DOMContentLoaded', renderHourlyBarChart);
        </script>

        <!-- Insights autom√°ticos -->
        <div class="bg-blue-50 p-4 rounded-lg">
          <div class="flex items-start space-x-3">
            <div class="flex-shrink-0">
              <svg class="w-5 h-5 text-blue-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div class="flex-1">
              <h4 class="text-sm font-medium text-blue-900">üí° Insights Autom√°ticos</h4>
              <div class="mt-2 text-sm text-blue-800 space-y-1">
                <% if using_real_data && total_real_clicks > 0 %>
                  <% peak_hour = complete_hourly_data.max_by { |hour, clicks| clicks } %>
                  <% if peak_hour %>
                    <div>üî• <strong>Hor√°rio de pico:</strong> <%= sprintf("%02d:00", peak_hour[0].to_i) %> (<%= peak_hour[1] %> cliques)</div>
                  <% end %>
                  <% afternoon_clicks = periods[2][:clicks] %>
                  <% if afternoon_clicks > 0 %>
                    <div>‚òÄÔ∏è <strong>Tarde ativa:</strong> <%= afternoon_clicks %> cliques entre 12h-17h</div>
                  <% end %>
                  <div>üìä <strong>Total analisado:</strong> <%= total_real_clicks %> cliques √∫nicos</div>
                <% else %>
                  <% peak_hour = complete_hourly_data.max_by { |hour, clicks| clicks } %>
                  <% if peak_hour %>
                    <div>üî• <strong>Hor√°rio de pico t√≠pico:</strong> <%= sprintf("%02d:00", peak_hour[0].to_i) %> (<%= peak_hour[1] %> cliques)</div>
                  <% end %>
                  <% afternoon_clicks = periods[2][:clicks] %>
                  <% if afternoon_clicks > 0 %>
                    <div>‚òÄÔ∏è <strong>Tarde ativa:</strong> <%= afternoon_clicks %> cliques entre 12h-17h</div>
                  <% end %>
                  <div>ÔøΩ <strong>Total simulado:</strong> <%= total_displayed_clicks %> cliques de exemplo</div>
                <% end %>
                <div>üìä <strong>Recomenda√ß√£o:</strong> Foque campanhas entre 12h-18h</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>
