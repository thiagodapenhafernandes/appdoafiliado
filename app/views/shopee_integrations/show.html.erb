<!-- app/views/shopee_integrations/show.html.erb -->
<div class="max-w-4xl mx-auto p-6 bg-white rounded-lg shadow-md">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Integração Shopee Affiliate</h1>
    
    <!-- Status Badge -->
    <% if @integration %>
      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
        <%= @integration.active? ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
        <span class="w-2 h-2 mr-2 rounded-full 
          <%= @integration.active? ? 'bg-green-400' : 'bg-red-400' %>"></span>
        <%= @integration.active? ? 'Ativo' : 'Inativo' %>
      </span>
    <% else %>
      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600">
        <span class="w-2 h-2 mr-2 bg-gray-400 rounded-full"></span>
        Não Configurado
      </span>
    <% end %>
  </div>

  <% if @integration %>
    <!-- Integration Status Card -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
      <h2 class="text-lg font-semibold text-blue-900 mb-4">Status da Integração</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="text-center">
          <div class="text-2xl font-bold text-blue-600" id="api-conversions-count">
            <%= @integration.affiliate_conversions.count %>
          </div>
          <div class="text-sm text-blue-700">Conversões da API</div>
        </div>
        
        <div class="text-center">
          <div class="text-2xl font-bold text-green-600" id="csv-conversions-count">
            <%= current_user.commissions.where(source: 'csv').count %>
          </div>
          <div class="text-sm text-green-700">Conversões CSV</div>
        </div>
        
        <div class="text-center">
          <div class="text-2xl font-bold text-purple-600" id="last-sync">
            <%= @integration.last_sync_at ? time_ago_in_words(@integration.last_sync_at) + " atrás" : "Nunca" %>
          </div>
          <div class="text-sm text-purple-700">Última Sincronização</div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-3 mb-6">
      <%= button_to "Testar Conexão", test_connection_shopee_integration_path, 
          method: :post,
          remote: true,
          class: "btn-secondary",
          id: "test-connection-btn",
          data: { confirm: "Testar conexão com a API Shopee?" } %>

      <%= button_to "Sincronizar Agora", sync_now_shopee_integration_path, 
          method: :post,
          remote: true,
          class: "btn-primary",
          id: "sync-now-btn",
          data: { confirm: "Iniciar sincronização manual das conversões?" } %>

      <%= button_to "Fazer Backfill", backfill_shopee_integration_path, 
          method: :post,
          remote: true,
          class: "btn-accent",
          id: "backfill-btn",
          data: { confirm: "Fazer backfill dos últimos 30 dias? Isso pode demorar alguns minutos." } %>

      <%= link_to "Editar Configuração", edit_shopee_integration_path, 
          class: "btn-outline" %>

      <%= button_to @integration.active? ? "Desativar" : "Ativar", 
          toggle_status_shopee_integration_path,
          method: :patch,
          remote: true,
          class: @integration.active? ? "btn-danger" : "btn-success",
          id: "toggle-status-btn",
          data: { confirm: @integration.active? ? "Desativar integração?" : "Ativar integração?" } %>
    </div>

    <!-- Configuration Details -->
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Detalhes da Configuração</h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">App ID</label>
          <div class="mt-1 text-sm text-gray-900 font-mono">
            <%= @integration.app_id.present? ? @integration.app_id[0..8] + "..." : "Não configurado" %>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Configurado em</label>
          <div class="mt-1 text-sm text-gray-900">
            <%= @integration.created_at.strftime("%d/%m/%Y às %H:%M") %>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Última Atualização</label>
          <div class="mt-1 text-sm text-gray-900">
            <%= @integration.updated_at.strftime("%d/%m/%Y às %H:%M") %>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Status de Sincronização</label>
          <div class="mt-1">
            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium
              <%= @integration.sync_in_progress? ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800' %>">
              <%= @integration.sync_in_progress? ? 'Sincronizando...' : 'Pronto' %>
            </span>
          </div>
        </div>
      </div>
    </div>

  <% else %>
    <!-- Setup Card -->
    <div class="text-center py-12">
      <div class="mx-auto w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mb-6">
        <svg class="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
        </svg>
      </div>
      
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Configure sua Integração Shopee</h2>
      <p class="text-gray-600 mb-8 max-w-md mx-auto">
        Conecte sua conta Shopee Affiliate para automatizar a importação de conversões via API.
      </p>
      
      <%= link_to "Configurar Integração", new_shopee_integration_path, 
          class: "btn-primary inline-flex items-center" %>
    </div>
  <% end %>
</div>

<!-- Progress Modal -->
<div id="progress-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <h3 class="text-lg font-medium text-gray-900 mb-2" id="progress-title">Processando...</h3>
        <p class="text-sm text-gray-600" id="progress-message">Aguarde, isso pode levar alguns momentos.</p>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('progress-modal');
  const progressTitle = document.getElementById('progress-title');
  const progressMessage = document.getElementById('progress-message');

  // Show progress modal for long-running operations
  document.getElementById('sync-now-btn')?.addEventListener('ajax:before', function() {
    progressTitle.textContent = 'Sincronizando...';
    progressMessage.textContent = 'Buscando conversões da API Shopee...';
    modal.classList.remove('hidden');
  });

  document.getElementById('backfill-btn')?.addEventListener('ajax:before', function() {
    progressTitle.textContent = 'Fazendo Backfill...';
    progressMessage.textContent = 'Isso pode demorar alguns minutos...';
    modal.classList.remove('hidden');
  });

  document.getElementById('test-connection-btn')?.addEventListener('ajax:before', function() {
    progressTitle.textContent = 'Testando Conexão...';
    progressMessage.textContent = 'Verificando credenciais com a API Shopee...';
    modal.classList.remove('hidden');
  });

  // Hide modal on completion
  document.addEventListener('ajax:complete', function() {
    modal.classList.add('hidden');
  });

  // Handle AJAX responses
  document.addEventListener('ajax:success', function(event) {
    const data = event.detail[0];
    
    if (data.message) {
      showNotification(data.message, data.success ? 'success' : 'error');
    }
    
    // Update counters if provided
    if (data.counters) {
      if (document.getElementById('api-conversions-count')) {
        document.getElementById('api-conversions-count').textContent = data.counters.api_conversions || 0;
      }
      if (document.getElementById('csv-conversions-count')) {
        document.getElementById('csv-conversions-count').textContent = data.counters.csv_conversions || 0;
      }
      if (document.getElementById('last-sync')) {
        document.getElementById('last-sync').textContent = data.counters.last_sync || 'Nunca';
      }
    }
    
    // Reload page for status toggle
    if (data.reload) {
      setTimeout(() => window.location.reload(), 1000);
    }
  });

  document.addEventListener('ajax:error', function(event) {
    const data = event.detail[0];
    showNotification(data.error || 'Erro ao processar solicitação', 'error');
  });

  function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
      type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Remove after 5 seconds
    setTimeout(() => {
      notification.remove();
    }, 5000);
  }
});
</script>
